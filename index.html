<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Our Calendar</title>
    <link
      rel="icon"
      type="image/x-icon"
      href="data:image/svg+xml;charset=UTF-8,%3csvg width='125mm' height='125mm' version='1.1' viewBox='0 0 125 125' xmlns='http://www.w3.org/2000/svg'%3e%3cg transform='translate(0,-172)'%3e%3cg transform='translate(-40.688 109.8)' fill='none' stroke='%23000' stroke-linecap='round' stroke-width='2'%3e%3cpath d='m103.19 69.458v22.225 22.225 22.225 22.226 22.225'/%3e%3cpath d='m103.19 105.18c35.719-35.719 35.719-35.719 35.719-35.719'/%3e%3cpath d='m67.469 69.458c35.719 35.719 35.719 35.719 35.719 35.719'/%3e%3cpath d='m125.68 105.18-22.49 22.49'/%3e%3cpath d='m103.19 127.67-22.49-22.49'/%3e%3cpath d='m138.91 105.18-35.719 35.719'/%3e%3cpath d='m103.19 140.9c-35.719-35.719-35.719-35.719-35.719-35.719'/%3e%3c/g%3e%3c/g%3e%3c/svg%3e"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.css"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-dark-5@1.1.3/dist/css/bootstrap-night.min.css"
      rel="stylesheet"
    />
    <style>
      #calendar {
        height: 100vh;
        padding: 1rem;
      }
      #event {
        padding-right: 2rem;
        max-height: 98vh;
        overflow-y: scroll;
      }
      .card-img-top {
        object-fit: cover;
      }
      .italic {
        font-style: italic;
      }
      th .fc-list-day-cushion {
        background-color: #183452;
      }
      .fc-event-title {
        padding-left: 6px;
        white-space: normal;
      }
      @media (max-width: 767.98px) {
        .fc .fc-toolbar.fc-header-toolbar {
          display: block;
          text-align: center;
        }

        .fc-header-toolbar .fc-toolbar-chunk {
          display: block;
          margin-bottom: 1rem;
        }
        #calendar {
          margin-top: 1rem;
          height: 80vh;
        }
        #event {
          padding: 1rem;
          overflow-y: visible;
        }
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.0.4/build/global/luxon.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <script src="events.js"></script>
    <script>
      var DateTime = luxon.DateTime;
      var calendarNames = [
        "buddhist",
        "chinese",
        "coptic",
        "ethioaa",
        "ethiopic",
        "hebrew",
        "indian",
        "islamic",
        "islamicc",
        "iso8601",
        "japanese",
        "persian",
        "roc",
      ];
      var cals = {};

      var toLocal = (date, cal) => {
        var parts = date.reconfigure({ outputCalendar: cal }).toLocaleParts();
        year = parseInt(
          parts.find((f) => f.type === "year" || f.type === "relatedYear").value
        );
        month = parseInt(parts.find((f) => f.type === "month").value);
        day = parseInt(parts.find((f) => f.type === "day").value);
        return { year, month, day };
      };

      var getCurrentYear = (cal) =>
        parseInt(
          DateTime.now()
            .reconfigure({ outputCalendar: cal })
            .toLocaleParts()
            .find((f) => f.type === "year" || f.type === "relatedYear").value
        );

      var buildDaysArray = (currentYearDic) => {
        var startYear = currentYearDic["iso8601"] - 3;
        var start = DateTime.fromObject({ year: startYear });
        return [...Array(6 * 365).keys()].map((i) => {
          var d = start.plus({ day: i });
          var result = {
            year: d.year,
            month: d.month,
            day: d.day,
            weekday: d.weekday,
          };
          calendarNames.forEach((c) => {
            result[c] = toLocal(d, c);
          });
          return result;
        });
      };

      var weekDaysToNumMap = {
        Mon: 1,
        Tue: 2,
        Wed: 3,
        Thu: 4,
        Fri: 5,
        Sat: 6,
        Sun: 7,
        0: 0,
      };

      getDate = (dateString, n, days, currentYearDic) => {
        var d = dateString.split("/");
        d[1] = weekDaysToNumMap[d[1]];
        d[0] = parseInt(d[0]);
        d[2] = parseInt(d[2]);
        count = parseInt(d[0]);
        var rev = count < 0;
        count += rev ? 1 : -1;
        try {
          if (d[1] === 0) {
            if (d[2] === 0) {
              var c = days.filter(
                (f) => f[d[3]].year === currentYearDic[d[3]] + n
              );
              var t = c[(rev ? c.length - 1 : 0) + count];
              return DateTime.fromObject({
                year: t.year,
                month: t.month,
                day: t.day,
              });
            } else {
              var c = days.filter(
                (f) =>
                  f[d[3]].year === currentYearDic[d[3]] + n &&
                  f[d[3]].month === d[2]
              );
              var t = c[(rev ? c.length - 1 : 0) + count];
              return DateTime.fromObject({
                year: t.year,
                month: t.month,
                day: t.day,
              });
            }
          } else {
            if (d[2] === 0) {
              var c = days.filter(
                (f) =>
                  f[d[3]].year === currentYearDic[d[3]] + n &&
                  f.weekday === d[1]
              );
              var t = c[(rev ? c.length - 1 : 0) + count];
              return DateTime.fromObject({
                year: t.year,
                month: t.month,
                day: t.day,
              });
            } else {
              var c = days.filter(
                (f) =>
                  f[d[3]].year === currentYearDic[d[3]] + n &&
                  f.weekday === d[1] &&
                  f[d[3]].month === d[2]
              );
              var t = c[(rev ? c.length - 1 : 0) + count];
              return DateTime.fromObject({
                year: t.year,
                month: t.month,
                day: t.day,
              });
            }
          }
        } catch (e) {
          console.log(e);
        }
      };

      var dayTimes = ["morning", "noon", "afternoon", "evening", "night"];
      var dayTimePrefixes = ["early ", "", "late "];
      var t = 0;
      var dayTimesDict = {};
      for (var dt = 0; dt < dayTimes.length; dt++) {
        for (var dtp = 0; dtp < dayTimePrefixes.length; dtp++) {
          dayTimesDict[`${dayTimePrefixes[dtp]}${dayTimes[dt]}`] = 9 + t++;
        }
      }
      getTime = (time) => {
        if (!time) {
          return { hour: 1 };
        }
        time = time.toLowerCase();
        if (dayTimes.some((f) => time.includes(f))) {
          return { hour: dayTimesDict[time.replaceAll("exact", "").trim()] };
        }
        var s = time.split(":");
        return {
          hour: s[0],
          minute: s.length > 1 ? s[1] : null,
          second: s.length > 1 ? s[2] : null,
        };
      };

      parseEvents = (days, currentYearDic) => {
        return [...Array(3).keys()]
          .flatMap((n) =>
            events.map((e) => {
              if (!e.date) return;
              var start = null,
                end = null,
                startTime = null,
                endTime = null,
                allDay = false;

              if (!e.time || e.time === "?" || e.time === "") {
                startTime = { hour: 9 };
                endTime = { hour: 23 };
                allDay = true;
              } else if (e.time.indexOf("~") > -1) {
                var times = e.time.split("~");
                startTime = getTime(times[0]);
                endTime = getTime(times[1]);
              } else {
                startTime = endTime = getTime(e.time);
              }

              if (e.date.indexOf("~") > -1) {
                var dates = e.date
                  .split("~")
                  .map((f) => getDate(f, n - 1, days, currentYearDic));
                start = dates[0].plus(startTime).toISO();
                end = dates[1].plus(endTime).toISO();
                allDay = false;
              } else {
                start = end = getDate(e.date, n - 1, days, currentYearDic);
                start = start.plus(startTime).toISO();
                end = end.plus(endTime).toISO();
              }

              return {
                title: e.name,
                start,
                end,
                allDay,
                extendedProps: {
                  image: e.image ?? "https://picsum.photos/200",
                  sub: e.description,
                  tag: e.tag,
                  link: e.link,
                },
              };
            })
          )
          .filter((f) => f);
      };
      showEvent = (event) => {
        var c = document.getElementById("event");
        var child = c.lastElementChild;
        while (child) {
          c.removeChild(child);
          child = c.lastElementChild;
        }
        card = document.createElement("div");
        card.classList.add("card");
        card.classList.add("mt-5");
        c.appendChild(card);
        console.log(event);
        if (event.extendedProps.image) {
          var image = document.createElement("img");
          image.src = event.extendedProps.image;
          image.classList.add("card-body-top");
          card.appendChild(image);
        }
        body = document.createElement("div");
        body.classList.add("card-body");
        card.appendChild(body);

        heading = document.createElement("h5");
        heading.innerText = event.title;
        heading.classList.add("card-title");
        body.appendChild(heading);

        if (event.extendedProps.sub && event.extendedProps.sub.trim() !== "") {
          desc = document.createElement("p");
          desc.innerText = event.extendedProps.sub.trim();
          desc.classList.add("card-text");
          body.appendChild(desc);
        }

        if (event.extendedProps.tag && event.extendedProps.tag.trim() !== "") {
          tag = document.createElement("p");
          tag.innerText = event.extendedProps.tag.trim();
          tag.classList.add("card-text");
          tag.classList.add("italic");
          body.appendChild(tag);
        }

        if (
          event.extendedProps.link &&
          event.extendedProps.link.trim() !== ""
        ) {
          link = document.createElement("a");
          link.href = event.extendedProps.link.trim();
          link.innerText = "More Info";
          link.classList.add("btn");
          link.classList.add("btn-link");
          body.appendChild(link);
        }
      };
      document.addEventListener("DOMContentLoaded", function () {
        var currentYearDic = calendarNames.reduce((a, i) => {
          a[i] = getCurrentYear(i);
          return a;
        }, {});
        var days = buildDaysArray(currentYearDic);
        parsedEvents = parseEvents(days, currentYearDic);

        var calendarEl = document.getElementById("calendar");
        var calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: "dayGridMonth",
          themeSystem: "bootstrap5",
          fixedWeekCount: false,
          firstDay: 1,
          headerToolbar: {
            left: "prev,next today",
            center: "title",
            right: "dayGridMonth,timeGridWeek,timeGridDay listMonth",
          },
          events: parsedEvents,
          eventClick: function (info) {
            showEvent(info.event);
            info.el.style.backgroundColor = "gray";
          },
        });
        calendar.render();
      });
    </script>
  </head>
  <body>
    <div class="container-fluid">
      <div class="row">
        <div class="col-sm-9 col-m-9">
          <div id="calendar"></div>
        </div>
        <div class="col-sm-3 col-m-9" id="event"></div>
      </div>
    </div>
  </body>
</html>
